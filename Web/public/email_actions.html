<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8 />
    <title>Contractor's Business Manager Email Action</title>

    <link rel='stylesheet' href='./stylesheets/main.css' media='screen and (orientation: landscape)'>
    <link rel='stylesheet' href='./stylesheets/mobile.css' media='screen and (orientation: portrait)'>

    <!-- Import and configure the Firebase SDK -->
    <script src="/__/firebase/5.3.0/firebase-app.js"></script>
    <script src="/__/firebase/5.3.0/firebase-auth.js"></script>
    <script src="/__/firebase/5.3.0/firebase-functions.js"></script>
    <script src="/__/firebase/init.js"></script>

    <script type="text/javascript">
      function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, '\\$&');
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
      }

      document.addEventListener ('DOMContentLoaded', function () {
        const iframe = document.getElementById('embeddedpage');
        iframe.width = document.body.clientWidth;

        // Get the action type
        var mode = getParameterByName('mode');
        // Get the one-time code from the query parameter
        var actionCode = getParameterByName('oobCode');
        // Get the API key from the query parameter, in case it's necessary
        var apiKey = getParameterByName('apiKey');
        // Get the continue URL from the query parameter if available, in case it's necessary
        var continueUrl = getParameterByName('continueUrl');

        // Configure the Firebase SDK.
        var auth = firebase.app().auth();

        // Handle the user management action.
        switch (mode) {
          case 'resetPassword':
            handleResetPassword(auth, actionCode, continueUrl);
            break;
          case 'recoverEmail':
            handleRecoverEmail(auth, actionCode);
            break;
          case 'verifyEmail':
            handleVerifyEmail(auth, actionCode, continueUrl);
            break;
          default:
            // Error: invalid mode
        }
      }, false);

      function handleResetPassword(auth, actionCode, continueUrl) {
        // Verify the password reset code is valid.
        auth.verifyPasswordResetCode(actionCode).then(function(email) {
          var accountEmail = email;

          // TODO: Show the reset screen with the user's email and ask the user for
          // the new password.
          iframe.src = "./password_reset.html";

          // Save the new password.
          auth.confirmPasswordReset(actionCode, newPassword).then(function(resp) {
            // Password reset has been confirmed and new password updated.

            // TODO: Display a link back to the app, or sign-in the user directly
            // if the page belongs to the same domain as the app:
            auth.signInWithEmailAndPassword(accountEmail, newPassword).catch((err) => {
              console.log ('signInWithEmailAndPassword fail: ' + err);
            });

            // TODO: If a continue URL is available, display a button which on
            // click redirects the user back to the app via continueUrl with
            // additional state determined from that URL's parameters.
          }).catch(function(err) {
            // Error occurred during confirmation. The code might have expired or the
            // password is too weak.
            console.log('confirmPasswordReset fail: ' + err);
          });
        }).catch(function(err) {
          // Invalid or expired action code. Ask user to try to reset the password
          // again.
          console.log('verifyPasswordResetCode fail: ' + err);
        });
      }

      function handleRecoverEmail(auth, actionCode) {
        var restoredEmail = null;
        // Confirm the action code is valid.
        auth.checkActionCode(actionCode).then(function(info) {
          // Get the restored email address.
          restoredEmail = info['data']['email'];

          // Revert to the old email.
          return auth.applyActionCode(actionCode);
        }).then(function() {
          // Account email reverted to restoredEmail

          // TODO: Display a confirmation message to the user.
          iframe.src = "./recover_email.html";

          // You might also want to give the user the option to reset their password
          // in case the account was compromised:
          auth.sendPasswordResetEmail(restoredEmail).then(function() {
            // Password reset confirmation sent. Ask user to check their email.
          }).catch(function(error) {
            // Error encountered while sending password reset code.
          });
        }).catch(function(error) {
          // Invalid code.
        });
      }

      function handleVerifyEmail(auth, actionCode, continueUrl) {
        // Try to apply the email verification code.
        auth.applyActionCode(actionCode).then(function(resp) {
          // Email address has been verified.

          // TODO: Display a confirmation message to the user.
          // You could also provide the user with a link back to the app.
          iframe.src = "./verify_email.html";

          // TODO: If a continue URL is available, display a button which on
          // click redirects the user back to the app via continueUrl with
          // additional state determined from that URL's parameters.
        }).catch(function(err) {
          // Code is invalid or expired. Ask the user to verify their email address
          // again.
          console.log(err);
        });
      }
    </script>
  </head>
  <body>
    <div class='message'>
      <br/>
      <h1 id='title'></h1>
      
      <nav>
        <div class='topnav'>
          <a href="./sign_in.html" style="float:right">Sign In</a>
          <a href="./index.html">Menu</a>

          <div class='dropdown'>
            <button class="dropbtn">Manage Hours</button>
            <div class="dropdown-content">
              <a href="./count_hours.html">Count Hours</a>
              <a href="./revise_hours.html">Revise Hours</a>
            </div>
          </div>

          <div class='dropdown'>
            <button class="dropbtn">Add Things</button>
            <div class="dropdown-content">
              <a href="./add_employees.html">Add Employees</a>
              <a href="./add_clients.html">Add Clients</a>
              <a href="./add_locations.html">Add Locations</a>
              <a href="./add_jobs.html">Add Jobs</a>
            </div>
          </div>

          <div class="dropdown">
            <button class="dropbtn">Edit Things</button>
            <div class="dropdown-content">
              <a href="./edit_employees.html">Edit Employees</a>
              <a href="./edit_clients.html">Edit Clients</a>
              <a href="./edit_locations.html">Edit Locations</a>
              <a href="./edit_jobs.html">Edit Jobs</a>
            </div>
          </div>
          
          <div class='dropdown'>
            <button class="dropbtn">Manage Schedules</button>
            <div class="dropdown-content">
              <a href="./schedule.html">Schedule Employees</a>
              <a href="./job_times.html">View Job Timelines</a>
            </div>
          </div>
        </div>
      </nav>
    </div>

    <main>
      <iframe src='./recover_email.html' id='embeddedpage' height='400px' style='background:white;border:none'>
        Sorry, this content had trouble loading.
      </iframe>
    </main>
  </body>
</html>